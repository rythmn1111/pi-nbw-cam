<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pi BnW Cam</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,200;0,400;0,700;1,200;1,400;1,700&display=swap" rel="stylesheet">
  <style>
    :root { --gap: 12px; }
    body{font-family:'Atkinson Hyperlegible',system-ui,Segoe UI,Arial,sans-serif;font-weight:200;max-width:980px;margin:24px auto;padding:0 16px;background:#ECE7E1;color:#333}
    h1{margin:0 0 12px;color:#eb5d40}
    .logo{height:120px;width:auto;display:block;margin:0 auto 8px}
    .toolbar{display:flex;flex-wrap:wrap;align-items:center;gap:10px;margin-bottom:10px}
    button{padding:10px 16px;border:0;border-radius:10px;font-weight:600;cursor:pointer}
    #captureBtn{background:#eb5d40;color:#fff}
    #uploadAllBtn{background:#ECE7E1;color:#eb5d40;border:2px solid #eb5d40}
    #status{margin:4px 0 16px;opacity:.8;min-height:1.2em;color:#eb5d40}
    .hero{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start}
    .hero img{width:100%;height:auto;border-radius:12px;display:block}
    .muted{opacity:.7;font-size:14px;color:#eb5d40}
    .section{margin-top:24px}
    .section h2{margin:0 0 8px;color:#eb5d40}
    .grid{display:grid;grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));gap: var(--gap);}
    .card{position:relative;overflow:hidden;border-radius:12px;box-shadow:0 1px 4px rgba(235,93,64,.2);background:#ECE7E1;border:2px solid #eb5d40;transition:transform .15s ease, box-shadow .15s ease}
    .card:hover{transform:translateY(-2px); box-shadow:0 6px 18px rgba(235,93,64,.3)}
    .thumb{width:100%;height:160px;object-fit:cover;display:block;filter:grayscale(100%) contrast(110%)}
    .meta{position:absolute;left:8px;bottom:6px;background:#eb5d40;color:#fff;font-size:12px;padding:2px 6px;border-radius:8px}
    .badge{position:absolute;right:8px;top:8px;font-size:12px;padding:2px 6px;border-radius:8px;background:#eb5d40;color:#fff}
    .actions{position:absolute;right:8px;bottom:8px;display:flex;gap:6px}
    .tiny{font-size:12px;padding:6px 8px;border-radius:8px;border:0;background:#eb5d40;color:#fff;opacity:.9}
    @media (max-width:720px){ .hero{grid-template-columns:1fr} }
  </style>
</head>
  <body>
    <img src="/logo.png" alt="EvenAfter Cam" class="logo">
  <div class="toolbar">
    <button id="captureBtn">üì∏ Capture BnW</button>
    <button id="uploadAllBtn">‚¨ÜÔ∏è Upload to Arweave</button>
    <span id="status" class="muted"></span>
  </div>

  <div class="hero">
    <div>
      <img id="preview" alt="Last capture will appear here" />
      <div class="muted">Latest image (auto-refreshes)</div>
    </div>
    
  </div>

  <div class="section">
    <h2>Local (not uploaded) <span class="muted" id="countLocal"></span></h2>
    <div id="gridLocal" class="grid"></div>
  </div>

  <div class="section">
    <h2>Archived on Arweave <span class="muted" id="countAr"></span></h2>
    <div id="gridAr" class="grid"></div>
  </div>

  <script>
    const btn = document.getElementById("captureBtn");
    const uploadAllBtn = document.getElementById("uploadAllBtn");
    const statusEl = document.getElementById("status");
    const img = document.getElementById("preview");
    const gridLocal = document.getElementById("gridLocal");
    const gridAr = document.getElementById("gridAr");
    const countLocal = document.getElementById("countLocal");
    const countAr = document.getElementById("countAr");

    async function capture() {
      btn.disabled = true;
      btn.textContent = "Capturing‚Ä¶";
      statusEl.textContent = "Taking picture and converting‚Ä¶";
      try {
        const r = await fetch("/capture", { method: "POST" });
        const data = await r.json();
        if (!data.ok) throw new Error(data.error || "Unknown error");
        img.src = data.url;
        statusEl.textContent = "Done.";
        await refreshGallery();
      } catch (e) {
        console.error(e);
        statusEl.textContent = e.message || "Failed to capture. Check server logs.";
      } finally {
        btn.disabled = false;
        btn.textContent = "üì∏ Capture BnW";
      }
    }
    btn.addEventListener("click", capture);

    async function uploadAll() {
      uploadAllBtn.disabled = true;
      uploadAllBtn.textContent = "Queueing‚Ä¶";
      statusEl.textContent = "Queueing all local images for Arweave upload‚Ä¶";
      try {
        const r = await fetch("/upload-all", { method: "POST" });
        const data = await r.json();
        if (!data.ok) throw new Error(data.error || "Failed");
        statusEl.textContent = `Queued ${data.queued} image(s). Uploads run in background.`;
      } catch (e) {
        console.error(e);
        statusEl.textContent = e.message || "Failed to queue uploads.";
      } finally {
        uploadAllBtn.disabled = false;
        uploadAllBtn.textContent = "‚¨ÜÔ∏è Upload to Arweave";
      }
    }
    uploadAllBtn.addEventListener("click", uploadAll);

    // SSE: captured -> refresh; uploaded -> refresh (moves from Local to Archived)
    const es = new EventSource("/events");
    es.onmessage = async (ev) => {
      try {
        const msg = JSON.parse(ev.data);
        if (msg.type === "captured") {
          img.src = "/latest.webp?ts=" + msg.ts;
          await refreshGallery();
        } else if (msg.type === "uploaded") {
          await refreshGallery();
        }
      } catch {}
    };

    function fmtBytes(n){
      if (n == null) return "";
      if (n < 1024) return n + " B";
      if (n < 1024*1024) return (n/1024).toFixed(1) + " KB";
      return (n/1024/1024).toFixed(2) + " MB";
    }

    function renderLocal(items){
      gridLocal.innerHTML = "";
      countLocal.textContent = `(${items.length})`;
      for (const it of items){
        const dt = new Date(it.mtimeMs);
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <a href="${it.url}" target="_blank" rel="noopener">
            <img class="thumb" loading="lazy" src="${it.url}" alt="${it.name}" />
          </a>
          <div class="meta">${dt.toLocaleString()} ¬∑ ${fmtBytes(it.size)}</div>
        `;
        gridLocal.appendChild(card);
      }
    }

    function renderArchived(items){
      gridAr.innerHTML = "";
      countAr.textContent = `(${items.length})`;
      for (const it of items){
        const when = it.uploadedAt ? new Date(it.uploadedAt).toLocaleString() : "";
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <a href="${it.url}" target="_blank" rel="noopener">
            <img class="thumb" loading="lazy" src="${it.url}" alt="${it.name}" />
          </a>
          <div class="meta">${when}${it.size ? " ¬∑ " + fmtBytes(it.size) : ""}</div>
          <a class="badge" href="${it.url}" target="_blank" rel="noopener">Arweave</a>
        `;
        gridAr.appendChild(card);
      }
    }

    async function refreshGallery(){
      try{
        const r = await fetch("/gallery.json");
        const data = await r.json();
        if (!data.ok) throw new Error("Gallery failed");
        renderLocal(data.local || []);
        renderArchived(data.archived || []);
      }catch(e){
        console.error(e);
        statusEl.textContent = "Failed to load gallery.";
      }
    }

    (async function init(){
      img.src = "/latest.webp?ts=" + Date.now();
      await refreshGallery();
    })();
  </script>
</body>
</html>
